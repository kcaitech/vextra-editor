<script setup lang="ts">
import { ref } from "vue";

const props = defineProps<{ type: string, value: number, range?: [number, number] }>();
const MAX_SIDE_LENGTH = 160;
const MAX_SIDE_LENGTH_CSS = `${MAX_SIDE_LENGTH}px`;

const valLength = ref<number>((() => {
    const val = props.value;
    if (!val) {
        return 0;
    } else {
        const max = (props.range || [-100, 100])[1];
        return (Math.abs(val) / max) * MAX_SIDE_LENGTH / 2;
    }
})());

const valStart = ref<number>((() => {
    const val = props.value;
    if (val < 0) {
        return (MAX_SIDE_LENGTH / 2) - valLength.value;
    } else {
        return MAX_SIDE_LENGTH / 2;
    }
})());

const position = ref<number>((() => {
    const val = props.value;
    if (!val) {
        return MAX_SIDE_LENGTH / 2;

    } else {
        const max = (props.range || [-100, 100])[1];
        return (MAX_SIDE_LENGTH / 2) + (val / max) * MAX_SIDE_LENGTH / 2
    }
})());

const rangeEl = ref<HTMLDivElement>();

let center: number = 0;
let start: number = 0;
let end: number = 0;
let downX = 0;
let isDrag = false;

function down(e: MouseEvent) {
    console.log('down')
    if (!rangeEl.value || e.button !== 0) return;
    e.stopPropagation();
    downX = e.clientX;
    const box = rangeEl.value.getBoundingClientRect();
    start = box.left;
    end = box.right;
    center = (start + end) / 2;

    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
    window.addEventListener('blur', blur);
}

function downSlider(e: MouseEvent) {
    console.log('downSlider')
    if (!rangeEl.value || e.button !== 0) return;
    e.stopPropagation();
    downX = e.clientX;
    const box = rangeEl.value.getBoundingClientRect();
    start = box.left;
    end = box.right;
    center = (start + end) / 2;

    modify(e);

    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
    window.addEventListener('blur', blur);
}

function modify(e: MouseEvent) {
    let x = e.x;
    if (x > center) {
        if (x > end) {
            x = end;
        }

        if (x - center < 3) {
            x = center;
        }

        valLength.value = x - center;
        valStart.value = center - start;
        position.value = valStart.value + valLength.value;
    } else {
        if (x < start) {
            x = start;
        }
        if (center - x < 3) {
            x = center;
        }

        valLength.value = center - x;
        valStart.value = x - start;
        position.value = x - start;
    }
}

function move(e: MouseEvent) {
    if (isDrag) {
        modify(e);
    } else if (Math.abs(e.clientX - downX) > 4) {
        isDrag = true;
    }
}

function up() {
    document.removeEventListener('mousemove', move);
    document.removeEventListener('mouseup', up);
}

function blur() {
    window.removeEventListener('blur', blur);
}
</script>
<template>
    <div class="container">
        <div class="desc">{{ type }}</div>
        <div ref="rangeEl"
             class="range"
             :style="{width: MAX_SIDE_LENGTH_CSS }"
             @mousedown="downSlider"
        >
            <div class="line"/>
            <div v-if="valLength"
                 class="line-center"
            />
            <div v-if="valLength"
                 class="val-line"
                 :style="{left: `${valStart}px`, width: `${valLength}px`}"
            />
            <div :style="{left: `${position}px`}"
                 :class="{dot: true, 'fill-dot': valLength}"
                 @mousedown="down"
            />
        </div>
    </div>
</template>
<style scoped lang="scss">
.container {
    width: 100%;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    position: relative;

    .range {
        display: flex;
        align-items: center;
        position: relative;
        height: 100%;

        .line {
            width: 100%;
            height: 2px;
            background-color: grey;
        }

        .line-center {
            width: 1px;
            background-color: grey;
            height: 8px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .val-line {
            height: 2px;
            background-color: black;
            position: absolute;
        }


        .dot {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            box-sizing: border-box;
            width: 10px;
            height: 10px;
            border: 1px solid black;
            border-radius: 50%;
            background-color: #fff;
        }

        .fill-dot {
            border: 1px solid #fff;
            background-color: black !important;
        }
    }
}
</style>