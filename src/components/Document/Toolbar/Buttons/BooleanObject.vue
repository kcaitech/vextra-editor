<script lang="ts" setup>
import { ref, nextTick, onMounted, onUnmounted } from 'vue';
import { Selection } from '@/context/selection';
import { Context } from '@/context';
import ToolButton from '../ToolButton.vue';
import DropSelect from "./DropSelect.vue"
import { BoolOp, BoolShapeView, ShapeType, ShapeView } from '@kcdesign/data';
import { useI18n } from 'vue-i18n'
import { message } from '@/utils/message';
const { t } = useI18n()
const props = defineProps<{ context: Context, selection: Selection }>();
type Button = InstanceType<typeof ToolButton>

const popoverVisible = ref<boolean>(false);
const popover = ref<HTMLDivElement>();
const button = ref<Button>();
const visible = ref(false)
const selectBool = ref('union')
const boolType = ref(BoolOp.Union)
const boolName = ref('union')
const state = ref(false)
const emit = defineEmits<{
  (e: "changeBool", type: BoolOp, name: string): void;
  (e: 'flattenShape'): void;
}>();

const patterns = ((items: [string, any, BoolOp][]) => (items.map(item => ({ value: item[0], content: item[1], bool: item[2] }))))([
  ['union', 'union', BoolOp.Union],
  ['subtract', 'subtract', BoolOp.Subtract],
  ['intersection', 'intersection', BoolOp.Intersect],
  ['difference', 'difference', BoolOp.Diff],
  ['cohere', 'cohere', BoolOp.None]
]);

function showMenu(e: MouseEvent) {
  e.stopPropagation()
  const selected = props.selection.selectedShapes;
  if (selected.length > 0 && selected.some(s => s.type === ShapeType.Cutout)) {
    message('feature', t('cutoutExport.cutoutNotBool'));
    return;
  }
  if (popoverVisible.value) return popoverVisible.value = false;
  if (button.value?.toolButtonEl) {
    const el = button.value?.toolButtonEl;
    visible.value = false
    popoverVisible.value = true;
    nextTick(() => {
      if (popover.value) {
        popover.value.style.left = el.offsetLeft + 'px';
        popover.value.style.top = el.offsetHeight + 13 + 'px';

      }
    })
    document.addEventListener('click', onMenuBlur);
  }
}

const selector = (active: string, type: BoolOp) => {
  if (active !== 'cohere') {
    selectBool.value = active
  }
  boolType.value = type
  popoverVisible.value = false;
  boolName.value = active
  if (active === 'cohere') {
    emit('flattenShape')
  } else {
    emit('changeBool', type, boolName.value);
  }
}

function onMenuBlur(e: MouseEvent) {
  if (e.target instanceof Element && !e.target.closest('.popover') && !e.target.closest('.menu')) {
    if (e.target.closest('.popover')) return;
    var timer = setTimeout(() => {
      popoverVisible.value = false;
      clearTimeout(timer)
      document.removeEventListener('click', onMenuBlur);
    }, 10)
  }
}
var timer: any = null
const onMouseenter = () => {
  timer = setTimeout(() => {
    visible.value = true
    clearTimeout(timer)
  }, 600)
}
const onMouseleave = () => {
  clearTimeout(timer)
  visible.value = false
}

const changeBool = () => {
  const selected = props.selection.selectedShapes;
  if (selected.length > 0 && selected.some(s => s.type === ShapeType.Cutout)) {
    message('info', t('cutoutExport.cutoutNotBool'));
    return;
  }
  emit('changeBool', boolType.value, boolName.value);
}

const selectionWatch = (t?: number) => {
  if (t === Selection.CHANGE_SHAPE) {
    const shapes = props.selection.selectedShapes
    getBoolGroupType(shapes)
  }
}

const getBoolGroupType = (shapes: ShapeView[]) => {
  if (shapes.length === 1 && shapes[0].type === ShapeType.BoolShape) {
    const type = (shapes[0] as BoolShapeView).getBoolOp()
    if (type.op === 'union') {
      selectBool.value = 'union'
    } else if (type.op === 'subtract') {
      selectBool.value = 'subtract'
    } else if (type.op === 'intersect') {
      selectBool.value = 'intersection'
    } else if (type.op === 'diff') {
      selectBool.value = 'difference'
    }
    if (type.op === 'none') {
      state.value = true
    } else {
      state.value = false
    }
  } else if (shapes.length > 1) {
    state.value = true
  }
}

onMounted(() => {
  const shapes = props.selection.selectedShapes
  getBoolGroupType(shapes)
  props.context.selection.watch(selectionWatch)
})
onUnmounted(() => {
  props.context.selection.unwatch(selectionWatch)
})

</script>

<template>
  <div ref="popover" class="popover" tabindex="-1" v-if="popoverVisible">
    <template v-for="(item, index) in patterns" :key="item.value">
      <div class="line" v-if="index === 4"></div>
      <DropSelect @selectBool="selector" :lg="item.value" :select="item.content" :bool="item.bool" type="bool"
        :d="selectBool" :state="state"></DropSelect>
    </template>
  </div>
  <el-tooltip class="box-item" effect="dark" :content="t(`bool.${selectBool}`)" placement="bottom" :show-after="600"
    :offset="10" :hide-after="0" :visible="popoverVisible ? false : visible">
    <ToolButton ref="button" @click="changeBool" :selected="false" @mouseenter.stop="onMouseenter"
      @mouseleave.stop="onMouseleave">
      <div class="svg-container" :class="{ active: state }">
        <svg-icon :icon-class="selectBool"></svg-icon>
      </div>
      <div class="menu" @click="showMenu">
        <svg-icon icon-class="white-down"></svg-icon>
      </div>
    </ToolButton>
  </el-tooltip>
</template>

<style lang="scss" scoped>
.svg-container {
  width: 32px;
  height: 32px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-left: 4px;
  color: #ffffff;
    padding: 6px 6px 6px 6px;
    box-sizing: border-box;
  
  >svg {
    width: 18px;
    height: 18px;
  }
}

.active {
  color: gray;
}

.menu {
  width: 20px;
  height: 28px;
  display: flex;
  //padding-right: 4px;
  //margin-right: 2px;
  justify-content: center;
  align-items: center;
  color: #ffffff;
  transition: 0.3s;
    padding: 10px 8px 10px 0;
    box-sizing: border-box;

  >svg {
    width: 12px;
    height: 12px;
  }
}

.menu:hover {
  transform: translateY(4px);
}

.popover {
  position: absolute;
  z-index: 999;
  width: 180px;
  height: auto;
  background-color: var(--theme-color);
  border-radius: 4px;
  outline: none;
  padding: var(--default-padding-half) 0;

  .line {
    width: 100%;
    height: 11px;
    border-width: 5px 0 5px 0;
    border-style: solid;
    border-color: var(--theme-color);
    box-sizing: border-box;
    background-color: rgba(255, 255, 255, .5)
  }
}
</style>