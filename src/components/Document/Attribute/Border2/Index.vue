<script lang="ts" setup>
import SvgIcon from "@/components/common/SvgIcon.vue";
import style_icon from "@/assets/icons/svg/styles.svg";
import add_icon from "@/assets/icons/svg/add.svg";
import delete_icon from '@/assets/icons/svg/delete.svg';

import { Context } from "@/context";
import { computed, onMounted, onUnmounted, reactive, ref, watch } from "vue";
import { FillCatch } from "@/components/Document/Attribute/Fill2/ctx";
import TypeHeader from "@/components/Document/Attribute/TypeHeader.vue";
import FillMaskView from "./FillMaskView.vue";
import FillItem from "./FillItem.vue";
import { useI18n } from "vue-i18n";
import { ElementManager, ElementStatus } from "@/components/common/elementmanager";
import FillStylePanel from "./Lib/FillStylePanel.vue";
import { BorderFillsContext, StrokeFillContextMgr } from "./ctx";
import StrokeView from "./Stroke/StrokeView.vue";
import StrokeMaskView from "./Stroke/StrokeMaskView.vue";
import StrokeStylePanel from "./Lib/StrokeStylePanel.vue";

/**
 * 每个模块的Index.vue应该包含
 *      Header
 *      Mask 或 自定义样式List
 *      样式库
 */
type Props = {
    context: Context;
    selectionChange: number;    // 选区变化
    trigger: any[];             // 选区内图层数据修改
}
const { t } = useI18n();

const props = defineProps<Props>();
const fillCtx = ref<BorderFillsContext>({  // 本组件的核心状态，改状态由vue进行劫持(注：选区和图层属于非vue劫持的状态，每个模块的状态由这两类状态共同组成)
    mixed: false,                        // 选区内是否存在不一样的填充样式

    fills: [],                           // 填充样式，有可能是样式库里拿出来的，也有可能是图层自带的。注：特别注意，这个数据本身属于由vue劫持的状态，
    // 所以它并不是直接从图层上或样式库里取出来的数据，而是由该数据经过vue二次包装后数据
    strokeInfo: undefined,
    strokeMask: undefined,
    strokeMaskInfo: undefined,
    mask: undefined,                     // 当选区内使用的样式库内的填充样式时，mask为该样式库的id，否则为undefined
    maskInfo: undefined                  // 当选区内使用的样式库内的填充样式时，maskInfo为改样式库的基本信息，包含名称和描述
});
const fillCtxMgr = new StrokeFillContextMgr(props.context, fillCtx.value as BorderFillsContext);                  // 核心状态管理器
const cloverVisible = computed<boolean>(() => !(fillCtx.value.mask || fillCtx.value.mixed));   // 样式库入口四叶草🍀是否可用
const fillLibStatus = reactive<ElementStatus>({ id: '#fill-style-lib-panel', visible: false });  // 样式库面板弹框状态
const strokeLibStatus = reactive<ElementStatus>({ id: '#stroke-style-lib-panel', visible: false });  // 样式库面板弹框状态
const fillPanelStatusMgr = new ElementManager(                                                       // 样式库面板弹框状态管理器，组件销毁时要调用其的unmounted事件
    props.context,
    fillLibStatus,
    { whiteList: ['.fill-style-lib-panel', '.clover', '.desc'] }                                   // 弹框可点击区域，区域之外的点击将会关闭弹框
);
fillCtxMgr.catchPanel(fillPanelStatusMgr);                                                           // 将弹框状态管理器加入到核心状态管理器，使得核心状态管理器可以控制弹框
const strokePanelStatusMgr = new ElementManager(
    props.context,
    strokeLibStatus,
    { whiteList: ['.stroke-style-lib-panel', '.border-style', '.border-left'] }
);
fillCtxMgr.catchPanel(strokePanelStatusMgr);
function showFillLib(event: MouseEvent) { /*打开填充样式库面板*/
    let e: Element | null = event.target as Element;
    while (e) {
        if (e.classList.contains('clover')) {
            fillPanelStatusMgr.showBy(e, { once: { offsetLeft: -164, offsetTop: 36 } });
            break;
        }
        if (e.classList.contains('desc')) {
            fillPanelStatusMgr.showBy(e, { once: { offsetLeft: -4, offsetTop: 36 } });
            break;
        }
        e = e.parentElement;
    }
}

const showBorderPanel = (event: MouseEvent) => {
    let e: Element | null = event.target as Element;
    while (e) {
        if (e.classList.contains('border-style')) {
            strokePanelStatusMgr.showBy(e, { once: { offsetLeft: -164, offsetTop: 36 } });
            break;
        }
        if (e.classList.contains('border-left')) {
            strokePanelStatusMgr.showBy(e, { once: { offsetLeft: -4, offsetTop: 36 } });
            break;
        }
        e = e.parentElement;
    }
}


const watchList: any[] = [
    watch(() => props.selectionChange, () => fillCtxMgr.update()),                  // 监听选区变化
    watch(() => props.trigger, v => v?.includes('style') && fillCtxMgr.update())    // 监听选区内图层的变化，与选区一样，监听到变化都应该修改核心状态
];

onMounted(() => {
    fillCtxMgr.update();
});
onUnmounted(() => {
    watchList.forEach(stop => stop());
    fillPanelStatusMgr.unmounted();
});
</script>
<template>
    <div class="fills-wrapper">
        <TypeHeader :title="t('attr.stroke')" class="mt-24" @click.stop="() => fillCtxMgr.init()"
            :active="!!fillCtx.fills.length">
            <template #tool>
                <div v-if="!fillCtx.strokeMask" class="border-style" @click="showBorderPanel">
                    <SvgIcon :icon="style_icon" />
                </div>
                <div class="add" @click.stop="() => fillCtxMgr.create()" v-if="!fillCtx.fills.length">
                    <SvgIcon :icon="add_icon" />
                </div>
                <div class="add" @click.stop="() => fillCtxMgr.removeAll()" v-else>
                    <SvgIcon :icon="delete_icon" />
                </div>
            </template>
        </TypeHeader>
        <StrokeView v-if="!fillCtx.strokeMask" :context="context" :manager="fillCtxMgr" :trigger="trigger"></StrokeView>
        <StrokeMaskView v-else :context="context" :manager="fillCtxMgr" :trigger="trigger"
            @showBorderPanel="showBorderPanel">
        </StrokeMaskView>
        <StrokeStylePanel v-if="strokeLibStatus.visible" :context="context" :manager="fillCtxMgr" i18n="borders"
            @close="() => strokePanelStatusMgr.close()"></StrokeStylePanel>
<!-- -------------------------------------------------------------------------------  -->
        <TypeHeader v-if="fillCtx.fills.length" :title="t('attr.stroke_color')" :active="!!fillCtx.fills.length">
            <template #tool>
                <div v-if="cloverVisible" class="clover" @click="showFillLib">
                    <SvgIcon :icon="style_icon" />
                </div>
                <div v-if="!fillCtx.mask" class="create" @click="() => fillCtxMgr.create()">
                    <SvgIcon :icon="add_icon" />
                </div>
            </template>
        </TypeHeader>
        <div v-if="fillCtx.mixed" class="tips-wrapper">{{ t('attr.mixed_lang') }}</div>
        <FillMaskView v-else-if="fillCtx.mask" :context="context" :manager="fillCtxMgr"
            :fills="(fillCtx.fills as FillCatch[])" :info="fillCtx.maskInfo!" @show-style-lib="showFillLib" />
        <div v-else-if="fillCtx.fills.length" class="fills-container">
            <FillItem v-for="(fill, index) in fillCtx.fills" :key="index" :context="context" :manager="fillCtxMgr"
                :data="(fill as FillCatch)" />
        </div>
        <FillStylePanel v-if="fillLibStatus.visible" :context="context" :manager="fillCtxMgr" i18n="colors"
            @close="() => fillPanelStatusMgr.close()" />
    </div>
</template>
<style scoped lang="scss">
.fills-wrapper {
    width: 100%;
    height: fit-content;
    padding: 12px 8px;
    box-sizing: border-box;
    border-bottom: 1px solid #F0F0F0;
    display: flex;
    flex-direction: column;
    gap: 4px;

    .add,
    .border-style {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        border-radius: var(--default-radius);
        transition: .2s;

        >img {
            width: 16px;
            height: 16px;
        }
    }

    .border-style img {
        padding: 2px;
        box-sizing: border-box;
    }

    .add:hover {
        background-color: #F5F5F5;
    }

    .border-style:hover {
        background-color: #F5F5F5;
    }

    .clover,
    .create {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--default-radius);
        transition: .2s;

        &:hover {
            background-color: #F5F5F5;
        }
    }

    .clover>img {
        width: 12px;
        height: 12px;
    }

    .create>img {
        width: 16px;
        height: 16px;
    }

    .tips-wrapper {
        padding: 12px 0;
        color: #737373;
        text-align: center;
        font-size: var(--font-default-fontsize);
    }

    .fills-container {
        display: flex;
        flex-direction: column;
        gap: 6px;

        width: 100%;
        height: fit-content;
        padding: 6px 0;
    }
}
</style>